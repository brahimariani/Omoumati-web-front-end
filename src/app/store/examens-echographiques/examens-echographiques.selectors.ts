import { createFeatureSelector, createSelector } from '@ngrx/store';
import { ExamensEchographiquesState } from './examens-echographiques.reducer';
import { ExamenEchographiqueResponse } from '../../core/models/examen_echographique/examen-echographique-response.model';

// ===== S√âLECTEUR DE FEATURE =====

export const selectExamensEchographiquesState = createFeatureSelector<ExamensEchographiquesState>('examens-echographiques');

// ===== S√âLECTEURS DE BASE =====

/**
 * S√©lectionner tous les examens √©chographiques
 */
export const selectAllExamensEchographiques = createSelector(
  selectExamensEchographiquesState,
  (state) => state.examens
);

/**
 * S√©lectionner l'examen √©chographique s√©lectionn√©
 */
export const selectSelectedExamenEchographique = createSelector(
  selectExamensEchographiquesState,
  (state) => state.selectedExamen
);

/**
 * S√©lectionner les examens √©chographiques r√©cents
 */
export const selectExamensEchographiquesRecents = createSelector(
  selectExamensEchographiquesState,
  (state) => state.examensRecents
);

/**
 * S√©lectionner les examens √©chographiques avec anomalies
 */
export const selectExamensEchographiquesAvecAnomalies = createSelector(
  selectExamensEchographiquesState,
  (state) => state.examensAvecAnomalies
);

// ===== S√âLECTEURS DE RECHERCHE =====

/**
 * S√©lectionner les r√©sultats de recherche
 */
export const selectSearchResults = createSelector(
  selectExamensEchographiquesState,
  (state) => state.searchResults
);

/**
 * S√©lectionner le terme de recherche actuel
 */
export const selectSearchTerm = createSelector(
  selectExamensEchographiquesState,
  (state) => state.searchTerm
);

/**
 * S√©lectionner les examens √©chographiques par consultation
 */
export const selectExamensByConsultation = (consultationId: string) => createSelector(
  selectExamensEchographiquesState,
  (state) => {
    const examens = state.examensByConsultation[consultationId] || [];
    console.log('üéØ S√©lecteur: Examens pour consultationId:', consultationId, 'Nombre:', examens.length, 'State:', state.examensByConsultation);
    return examens;
  }
);

/**
 * S√©lectionner les examens √©chographiques par trimestre
 */
export const selectExamensByTrimestre = (trimestre: 1 | 2 | 3) => createSelector(
  selectExamensEchographiquesState,
  (state) => state.examensByTrimestre[trimestre] || []
);

// ===== S√âLECTEURS POUR LES IMAGES =====

/**
 * S√©lectionner les images par examen
 */
export const selectImagesByExamen = (examenId: string) => createSelector(
  selectExamensEchographiquesState,
  (state) => state.imagesByExamen[examenId] || []
);

/**
 * S√©lectionner toutes les images
 */
export const selectAllImages = createSelector(
  selectExamensEchographiquesState,
  (state) => {
    const allImages = [];
    for (const examenId in state.imagesByExamen) {
      allImages.push(...state.imagesByExamen[examenId]);
    }
    return allImages;
  }
);

/**
 * S√©lectionner le nombre total d'images
 */
export const selectTotalImagesCount = createSelector(
  selectAllImages,
  (images) => images.length
);

// ===== S√âLECTEURS POUR LES ANALYSES =====

/**
 * S√©lectionner les analyses de mesures par examen
 */
export const selectAnalysesMesuresByExamen = (examenId: string) => createSelector(
  selectExamensEchographiquesState,
  (state) => state.analysesMesures[examenId] || []
);

/**
 * S√©lectionner les analyses avec anomalies
 */
export const selectAnalysesAvecAnomalies = createSelector(
  selectExamensEchographiquesState,
  (state) => {
    const analysesAvecAnomalies = [];
    for (const examenId in state.analysesMesures) {
      const analyses = state.analysesMesures[examenId];
      const anomalies = analyses.filter(a => a.statut === 'anormal' || a.statut === 'critique');
      if (anomalies.length > 0) {
        analysesAvecAnomalies.push({ examenId, analyses: anomalies });
      }
    }
    return analysesAvecAnomalies;
  }
);

/**
 * S√©lectionner les analyses critiques
 */
export const selectAnalysesCritiques = createSelector(
  selectExamensEchographiquesState,
  (state) => {
    const analysesCritiques = [];
    for (const examenId in state.analysesMesures) {
      const analyses = state.analysesMesures[examenId];
      const critiques = analyses.filter(a => a.statut === 'critique');
      if (critiques.length > 0) {
        analysesCritiques.push({ examenId, analyses: critiques });
      }
    }
    return analysesCritiques;
  }
);

// ===== S√âLECTEURS D'√âTAT =====

/**
 * S√©lectionner l'√©tat de chargement
 */
export const selectExamensEchographiquesLoading = createSelector(
  selectExamensEchographiquesState,
  (state) => state.loading
);

/**
 * S√©lectionner l'√©tat de chargement d'un examen
 */
export const selectExamenEchographiqueLoading = createSelector(
  selectExamensEchographiquesState,
  (state) => state.loadingExamen
);

/**
 * S√©lectionner l'√©tat de chargement des analyses
 */
export const selectAnalysesLoading = createSelector(
  selectExamensEchographiquesState,
  (state) => state.loadingAnalyse
);

/**
 * S√©lectionner l'√©tat de chargement des images
 */
export const selectImagesLoading = createSelector(
  selectExamensEchographiquesState,
  (state) => state.loadingImages
);

/**
 * S√©lectionner l'√©tat de chargement des statistiques
 */
export const selectStatistiquesLoading = createSelector(
  selectExamensEchographiquesState,
  (state) => state.loadingStatistiques
);

/**
 * S√©lectionner l'√©tat de chargement de la recherche
 */
export const selectSearchLoading = createSelector(
  selectExamensEchographiquesState,
  (state) => state.searchLoading
);

/**
 * S√©lectionner l'√©tat de chargement de l'export
 */
export const selectExportLoading = createSelector(
  selectExamensEchographiquesState,
  (state) => state.exportLoading
);

/**
 * S√©lectionner l'erreur
 */
export const selectExamensEchographiquesError = createSelector(
  selectExamensEchographiquesState,
  (state) => state.error
);

// ===== S√âLECTEURS DE PAGINATION ET TRI =====

/**
 * S√©lectionner la pagination
 */
export const selectPagination = createSelector(
  selectExamensEchographiquesState,
  (state) => state.pagination
);

/**
 * S√©lectionner le tri
 */
export const selectSorting = createSelector(
  selectExamensEchographiquesState,
  (state) => state.sorting
);

/**
 * S√©lectionner les filtres
 */
export const selectFilters = createSelector(
  selectExamensEchographiquesState,
  (state) => state.filters
);

// ===== S√âLECTEURS DE STATISTIQUES =====

/**
 * S√©lectionner les statistiques
 */
export const selectStatistiques = createSelector(
  selectExamensEchographiquesState,
  (state) => state.statistiques
);

/**
 * S√©lectionner l'URL d'export
 */
export const selectExportUrl = createSelector(
  selectExamensEchographiquesState,
  (state) => state.exportUrl
);

// ===== S√âLECTEURS COMPOS√âS =====

/**
 * S√©lectionner les examens √©chographiques avec leurs images
 */
export const selectExamensAvecImages = createSelector(
  selectAllExamensEchographiques,
  selectExamensEchographiquesState,
  (examens, state) => {
    return examens.map(examen => ({
      ...examen,
      images: state.imagesByExamen[examen.id] || []
    }));
  }
);

/**
 * S√©lectionner les examens √©chographiques avec leurs analyses
 */
export const selectExamensAvecAnalyses = createSelector(
  selectAllExamensEchographiques,
  selectExamensEchographiquesState,
  (examens, state) => {
    return examens.map(examen => ({
      ...examen,
      analyses: state.analysesMesures[examen.id] || []
    }));
  }
);

/**
 * S√©lectionner un examen √©chographique par ID avec ses images et analyses
 */
export const selectExamenCompletById = (id: string) => createSelector(
  selectAllExamensEchographiques,
  selectExamensEchographiquesState,
  (examens, state) => {
    const examen = examens.find(e => e.id === id);
    if (!examen) return null;
    
    return {
      ...examen,
      images: state.imagesByExamen[id] || [],
      analyses: state.analysesMesures[id] || []
    };
  }
);

/**
 * S√©lectionner les examens √©chographiques filtr√©s
 */
export const selectExamensEchographiquesFiltres = createSelector(
  selectAllExamensEchographiques,
  selectFilters,
  (examens, filters) => {
    let examensFilters = [...examens];

    // Filtrer par consultation
    if (filters.consultationId) {
      examensFilters = examensFilters.filter(e => 
        e.id === filters.consultationId // Adapter selon la structure du mod√®le
      );
    }

    // Filtrer par trimestre
    if (filters.trimestre) {
      // Logique de filtrage par trimestre bas√©e sur l'√¢ge gestationnel
      // √Ä adapter selon la logique m√©tier
    }

    // Filtrer par terme de recherche
    if (filters.searchTerm) {
      const term = filters.searchTerm.toLowerCase();
      examensFilters = examensFilters.filter(e =>
        e.observation?.toLowerCase().includes(term) ||
        e.placenta?.toLowerCase().includes(term) ||
        e.liquideAmniotique?.toLowerCase().includes(term)
      );
    }

    // Filtrer par pr√©sence d'images
    if (filters.avecImages !== undefined) {
      examensFilters = examensFilters.filter(e => {
        const hasImages = (e.images && e.images.length > 0);
        return filters.avecImages ? hasImages : !hasImages;
      });
    }

    return examensFilters;
  }
);

/**
 * S√©lectionner le nombre total d'examens √©chographiques
 */
export const selectTotalExamensCount = createSelector(
  selectAllExamensEchographiques,
  (examens) => examens.length
);

/**
 * S√©lectionner le nombre d'examens avec anomalies
 */
export const selectExamensAvecAnomaliesCount = createSelector(
  selectExamensEchographiquesAvecAnomalies,
  (examens) => examens.length
);



/**
 * S√©lectionner les examens √©chographiques tri√©s
 */
export const selectExamensEchographiquesTries = createSelector(
  selectAllExamensEchographiques,
  selectSorting,
  (examens, sorting) => {
    const examensTri√©s = [...examens];
    
    examensTri√©s.sort((a, b) => {
      let valueA: any;
      let valueB: any;
      
      switch (sorting.sortBy) {
        case 'id':
          valueA = a.id;
          valueB = b.id;
          break;
        case 'nbEmbryons':
          valueA = a.nbEmbryons;
          valueB = b.nbEmbryons;
          break;
        case 'observation':
          valueA = a.observation || '';
          valueB = b.observation || '';
          break;
        default:
          return 0;
      }
      
      if (valueA < valueB) {
        return sorting.sortDir === 'asc' ? -1 : 1;
      }
      if (valueA > valueB) {
        return sorting.sortDir === 'asc' ? 1 : -1;
      }
      return 0;
    });
    
    return examensTri√©s;
  }
);