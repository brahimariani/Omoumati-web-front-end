# üìã Guide d'utilisation du ConsultationService

## üéØ Vue d'ensemble

Le `ConsultationService` est un service complet pour la gestion des consultations m√©dicales dans l'application Omoumati. Il fournit toutes les op√©rations CRUD ainsi que des fonctionnalit√©s avanc√©es comme la recherche, les statistiques, l'export et la gestion de mod√®les.

## üèóÔ∏è Fonctionnalit√©s principales

### ‚úÖ Op√©rations CRUD de base
- Cr√©er une nouvelle consultation
- R√©cup√©rer toutes les consultations (avec pagination)
- R√©cup√©rer une consultation par ID
- Mettre √† jour une consultation
- Supprimer une consultation

### ‚úÖ Fonctionnalit√©s sp√©cialis√©es
- R√©cup√©rer les consultations par grossesse
- Recherche avanc√©e avec filtres
- Statistiques des consultations
- Export PDF/Excel
- V√©rification des consultations dues
- Mod√®les de consultation pr√©d√©finis
- Cache intelligent pour optimiser les performances

## üì¶ Import et injection

```typescript
import { ConsultationService } from '../../core/services/consultation.service';
import { ConsultationRequest, ConsultationResponse } from '../../core/models/consultation/';

@Component({...})
export class MonComposant {
  constructor(private consultationService: ConsultationService) {}
}
```

## üîß Utilisation des m√©thodes

### 1. Cr√©er une consultation

```typescript
createNewConsultation(grossesseId: string) {
  const consultation: ConsultationRequest = {
    date: new Date(),
    observation: 'Consultation de routine - tout va bien',
    grossesseId: grossesseId
  };

  this.consultationService.createConsultation(consultation)
    .subscribe({
      next: (consultation) => {
        console.log('Consultation cr√©√©e:', consultation);
        // Le cache est automatiquement mis √† jour
      },
      error: (error) => {
        console.error('Erreur:', error);
      }
    });
}
```

### 2. R√©cup√©rer les consultations d'une grossesse

```typescript
loadConsultationsForPregnancy(grossesseId: string) {
  // Version avec pagination compl√®te
  this.consultationService.getConsultationsByGrossesse(grossesseId, 0, 20)
    .subscribe({
      next: (response) => {
        this.consultations = response.data;
        this.totalElements = response.totalElements;
      }
    });

  // Version simple pour affichage direct
  this.consultationService.getConsultationsByGrossesseSimple(grossesseId)
    .subscribe({
      next: (consultations) => {
        this.consultations = consultations;
      }
    });
}
```

### 3. Mettre √† jour une consultation

```typescript
updateConsultation(consultationId: string, updatedData: ConsultationRequest) {
  this.consultationService.updateConsultation(consultationId, updatedData)
    .subscribe({
      next: (consultation) => {
        console.log('Consultation mise √† jour:', consultation);
        // Le cache est automatiquement mis √† jour
      },
      error: (error) => {
        console.error('Erreur de mise √† jour:', error);
      }
    });
}
```

### 4. Recherche avanc√©e

```typescript
searchConsultations() {
  const searchParams = {
    grossesseId: 'abc123',
    dateDebut: new Date('2024-01-01'),
    dateFin: new Date('2024-12-31'),
    observation: 'routine',
    page: 0,
    size: 10
  };

  this.consultationService.searchConsultations(searchParams)
    .subscribe({
      next: (response) => {
        this.searchResults = response.data;
      }
    });
}
```

### 5. Obtenir les statistiques

```typescript
loadConsultationStats(grossesseId?: string) {
  this.consultationService.getConsultationStats(grossesseId)
    .subscribe({
      next: (stats) => {
        console.log('Total consultations:', stats.totalConsultations);
        console.log('Consultations par mois:', stats.consultationsParMois);
        console.log('Derni√®re consultation:', stats.derniereConsultation);
      }
    });
}
```

### 6. V√©rifier si une consultation est due

```typescript
checkIfConsultationDue(grossesseId: string) {
  this.consultationService.checkConsultationDue(grossesseId)
    .subscribe({
      next: (result) => {
        if (result.isDue) {
          console.log(`Consultation due depuis ${result.daysSinceLastConsultation} jours`);
          console.log(`Date recommand√©e: ${result.recommendedDate}`);
        }
      }
    });
}
```

### 7. Utiliser les mod√®les de consultation

```typescript
loadTemplatesAndCreate() {
  // Charger les mod√®les disponibles
  this.consultationService.getConsultationTemplates()
    .subscribe({
      next: (templates) => {
        this.availableTemplates = templates;
      }
    });
}

createFromTemplate(templateId: string, grossesseId: string) {
  this.consultationService.createConsultationFromTemplate(templateId, grossesseId)
    .subscribe({
      next: (consultation) => {
        console.log('Consultation cr√©√©e depuis le mod√®le:', consultation);
      }
    });
}
```

### 8. Export de donn√©es

```typescript
exportToPdf(grossesseId: string) {
  this.consultationService.exportConsultationsPdf(grossesseId)
    .subscribe({
      next: (blob) => {
        // Cr√©er un lien de t√©l√©chargement
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `consultations-${grossesseId}.pdf`;
        link.click();
        window.URL.revokeObjectURL(url);
      }
    });
}

exportToExcel(grossesseId: string) {
  this.consultationService.exportConsultationsExcel(grossesseId)
    .subscribe({
      next: (blob) => {
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `consultations-${grossesseId}.xlsx`;
        link.click();
        window.URL.revokeObjectURL(url);
      }
    });
}
```

## üéØ Gestion du cache

Le service int√®gre un syst√®me de cache intelligent :

```typescript
// Observer les changements du cache
ngOnInit() {
  this.consultationService.consultations$
    .subscribe(consultations => {
      this.consultations = consultations;
    });
}

// Vider le cache manuellement
clearConsultationsCache() {
  this.consultationService.clearCache();
}

// Rafra√Æchir le cache pour une grossesse
refreshDataForPregnancy(grossesseId: string) {
  this.consultationService.refreshConsultationsForGrossesse(grossesseId)
    .subscribe(consultations => {
      console.log('Cache rafra√Æchi:', consultations);
    });
}
```

## üîß Gestion des erreurs

Le service g√®re automatiquement les erreurs HTTP communes :

```typescript
// Les erreurs sont automatiquement intercept√©es et format√©es
this.consultationService.createConsultation(data)
  .subscribe({
    next: (result) => { /* succ√®s */ },
    error: (errorMessage: string) => {
      // errorMessage contient un message d'erreur fran√ßais lisible
      this.showErrorMessage(errorMessage);
    }
  });
```

### Messages d'erreur automatiques :
- `400` ‚Üí "Donn√©es de consultation invalides"
- `401` ‚Üí "Non autoris√© - Veuillez vous reconnecter"
- `403` ‚Üí "Acc√®s interdit"
- `404` ‚Üí "Consultation non trouv√©e"
- `409` ‚Üí "Conflit - La consultation existe d√©j√†"
- `422` ‚Üí "Donn√©es de consultation non valides"
- `500` ‚Üí "Erreur serveur - Veuillez r√©essayer plus tard"

## üé® Int√©gration avec les composants

### Exemple complet dans un composant

```typescript
@Component({
  selector: 'app-consultation-manager',
  template: `
    <div class="consultation-manager">
      <!-- Liste des consultations -->
      <div *ngFor="let consultation of consultations">
        {{ consultation.date | date }} - {{ consultation.observation }}
      </div>
      
      <!-- Statistiques -->
      <div class="stats" *ngIf="stats">
        Total: {{ stats.totalConsultations }}
      </div>
    </div>
  `
})
export class ConsultationManagerComponent implements OnInit {
  consultations: ConsultationResponse[] = [];
  stats: any;

  constructor(private consultationService: ConsultationService) {}

  ngOnInit() {
    this.loadData();
    this.subscribeToCache();
  }

  private loadData() {
    const grossesseId = 'abc123';
    
    // Charger les consultations
    this.consultationService.getConsultationsByGrossesseSimple(grossesseId)
      .subscribe(consultations => {
        this.consultations = consultations;
      });
    
    // Charger les statistiques
    this.consultationService.getConsultationStats(grossesseId)
      .subscribe(stats => {
        this.stats = stats;
      });
  }

  private subscribeToCache() {
    // S'abonner aux changements du cache
    this.consultationService.consultations$
      .subscribe(consultations => {
        this.consultations = consultations;
      });
  }
}
```

## üöÄ Bonnes pratiques

### 1. Utilisation du cache
- Le cache est automatiquement mis √† jour lors des op√©rations CRUD
- Utilisez `consultations$` pour les mises √† jour en temps r√©el
- Videz le cache si n√©cessaire avec `clearCache()`

### 2. Gestion des abonnements
```typescript
export class MonComposant implements OnInit, OnDestroy {
  private destroy$ = new Subject<void>();

  ngOnInit() {
    this.consultationService.consultations$
      .pipe(takeUntil(this.destroy$))
      .subscribe(consultations => {
        // Traitement des donn√©es
      });
  }

  ngOnDestroy() {
    this.destroy$.next();
    this.destroy$.complete();
  }
}
```

### 3. Optimisation des performances
- Utilisez la pagination pour les grandes listes
- Exploitez le cache pour √©viter les appels API redondants
- Utilisez `getConsultationsByGrossesseSimple()` pour les affichages simples

## üìä Endpoints API support√©s

Le service supporte les endpoints suivants :

```
GET    /consultations                     - Liste pagin√©e
POST   /consultations                     - Cr√©er
GET    /consultations/{id}               - R√©cup√©rer par ID
PUT    /consultations/{id}               - Mettre √† jour
DELETE /consultations/{id}               - Supprimer
GET    /consultations/grossesse/{id}     - Par grossesse
GET    /consultations/search             - Recherche
GET    /consultations/stats              - Statistiques
GET    /consultations/templates          - Mod√®les
POST   /consultations/from-template      - Cr√©er depuis mod√®le
GET    /consultations/grossesse/{id}/export/pdf   - Export PDF
GET    /consultations/grossesse/{id}/export/excel - Export Excel
GET    /consultations/grossesse/{id}/check-due    - V√©rifier √©ch√©ance
```

## ‚ú® Conclusion

Le `ConsultationService` fournit une interface compl√®te et robuste pour la gestion des consultations m√©dicales avec :

- üîÑ Cache intelligent automatique
- üõ°Ô∏è Gestion d'erreurs robuste
- üìä Fonctionnalit√©s avanc√©es (stats, export, mod√®les)
- üéØ API simple et intuitive
- ‚ö° Optimisations de performance int√©gr√©es

Il constitue une base solide pour d√©velopper des interfaces utilisateur riches et r√©actives pour la gestion des consultations dans l'application Omoumati. 